# Azure DevOps Pipeline: AKS Store Demo
# Phase 2: Helm-based Deployment with Multi-Environment Support
#
# Prerequisites:
# 1. Kubernetes service connection named 'aks-dev'
# 2. Self-hosted agent pool 'Default' (or request free parallelism)

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - 'charts/**'
      - 'azure-pipelines.yml'

pr: none

# Parameters show as UI elements when you click "Run pipeline"
parameters:
  - name: deployInfra
    displayName: 'Deploy Infrastructure (NGINX Ingress)?'
    type: boolean
    default: false

variables:
  kubernetesServiceConnection: 'aks-dev'
  chartPath: 'charts/aks-store-demo'
  releaseName: 'aks-store'

stages:
  # ============================================
  # INFRASTRUCTURE STAGE - Install Dependencies
  # ============================================
  - stage: Infrastructure
    displayName: 'Setup Infrastructure'
    condition: eq('${{ parameters.deployInfra }}', 'True')
    jobs:
      - job: InstallIngress
        displayName: 'Install NGINX Ingress Controller'
        pool:
          name: 'Default'
        steps:
          - task: HelmInstaller@0
            displayName: 'Install Helm'
            inputs:
              helmVersion: '3.14.0'

          # Add NGINX Ingress Helm repo
          - task: HelmDeploy@0
            displayName: 'Add Ingress Repo'
            inputs:
              connectionType: 'Kubernetes Service Connection'
              kubernetesServiceEndpoint: $(kubernetesServiceConnection)
              command: 'repo'
              arguments: 'add ingress-nginx https://kubernetes.github.io/ingress-nginx'
            continueOnError: true  # Repo might already exist

          - task: HelmDeploy@0
            displayName: 'Update Helm Repos'
            inputs:
              connectionType: 'Kubernetes Service Connection'
              kubernetesServiceEndpoint: $(kubernetesServiceConnection)
              command: 'repo'
              arguments: 'update'

          # Install NGINX Ingress Controller
          - task: HelmDeploy@0
            displayName: 'Install NGINX Ingress'
            inputs:
              connectionType: 'Kubernetes Service Connection'
              kubernetesServiceEndpoint: $(kubernetesServiceConnection)
              namespace: 'ingress-nginx'
              command: 'upgrade'
              chartType: 'Name'
              chartName: 'ingress-nginx/ingress-nginx'
              releaseName: 'ingress-nginx'
              install: true
              waitForExecution: true
              arguments: '--create-namespace --timeout 5m'

  # ============================================
  # DEV STAGE
  # ============================================
  - stage: DeployDev
    displayName: 'Deploy to Dev'
    dependsOn: Infrastructure
    condition: not(failed('Infrastructure'))  # Run if succeeded OR skipped
    variables:
      namespace: 'dev'
      valuesFile: 'values-dev.yaml'
    jobs:
      - deployment: DeployHelmDev
        displayName: 'Deploy via Helm (Dev)'
        pool:
          name: 'Default'
        environment: 'dev'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                # Install Helm (if not available)
                - task: HelmInstaller@0
                  displayName: 'Install Helm'
                  inputs:
                    helmVersion: '3.14.0'

                # Create namespace if not exists
                - task: Kubernetes@1
                  displayName: 'Create Namespace'
                  inputs:
                    connectionType: 'Kubernetes Service Connection'
                    kubernetesServiceEndpoint: $(kubernetesServiceConnection)
                    command: 'apply'
                    useConfigurationFile: true
                    configurationType: 'inline'
                    inline: |
                      apiVersion: v1
                      kind: Namespace
                      metadata:
                        name: $(namespace)
                        labels:
                          environment: dev

                # Deploy with Helm
                - task: HelmDeploy@0
                  displayName: 'Helm Upgrade/Install'
                  inputs:
                    connectionType: 'Kubernetes Service Connection'
                    kubernetesServiceEndpoint: $(kubernetesServiceConnection)
                    namespace: $(namespace)
                    command: 'upgrade'
                    chartType: 'FilePath'
                    chartPath: $(chartPath)
                    releaseName: $(releaseName)
                    install: true
                    waitForExecution: true
                    arguments: '-f $(chartPath)/$(valuesFile) --timeout 5m'

                # Verify deployment
                - task: Kubernetes@1
                  displayName: 'Verify Pods'
                  inputs:
                    connectionType: 'Kubernetes Service Connection'
                    kubernetesServiceEndpoint: $(kubernetesServiceConnection)
                    namespace: $(namespace)
                    command: 'get'
                    arguments: 'pods -o wide'

                # Get service endpoints
                - task: Kubernetes@1
                  displayName: 'Get Services'
                  inputs:
                    connectionType: 'Kubernetes Service Connection'
                    kubernetesServiceEndpoint: $(kubernetesServiceConnection)
                    namespace: $(namespace)
                    command: 'get'
                    arguments: 'svc'

  # ============================================
  # PROD STAGE (Future - with approval gate)
  # ============================================
  # - stage: DeployProd
  #   displayName: 'Deploy to Prod'
  #   dependsOn: DeployDev
  #   condition: succeeded()
  #   variables:
  #     namespace: 'prod'
  #     valuesFile: 'values-prod.yaml'
  #   jobs:
  #     - deployment: DeployHelmProd
  #       displayName: 'Deploy via Helm (Prod)'
  #       pool:
  #         name: 'Default'
  #       environment: 'prod'  # Add approval gate in Azure DevOps
  #       strategy:
  #         runOnce:
  #           deploy:
  #             steps:
  #               # Same steps as dev...
