# Azure DevOps Pipeline: AKS Store Demo
# Phase 1: Simple Deploy using Raw Manifest
# 
# Prerequisites:
# 1. Create Azure DevOps project
# 2. Create Kubernetes service connection named 'aks-dev'
# 3. Import this repo or connect via GitHub

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - 'aks-store-quickstart.yaml'
      - 'azure-pipelines.yml'

# Manual trigger also available
pr: none

variables:
  kubernetesServiceConnection: 'aks-dev'
  namespace: 'pets'
  manifestFile: 'aks-store-quickstart.yaml'

stages:
  - stage: Deploy
    displayName: 'Deploy to AKS'
    jobs:
      - deployment: DeployToAKS
        displayName: 'Deploy AKS Store Demo'
        pool:
          name: 'Default'  # Self-hosted agent
        environment: 'dev'
        strategy:
          runOnce:
            deploy:
              steps:
                # Checkout code
                - checkout: self

                # Create namespace if it doesn't exist (idempotent)
                - task: Kubernetes@1
                  displayName: 'Create Namespace (if not exists)'
                  inputs:
                    connectionType: 'Kubernetes Service Connection'
                    kubernetesServiceEndpoint: $(kubernetesServiceConnection)
                    command: 'apply'
                    useConfigurationFile: true
                    configurationType: 'inline'
                    inline: |
                      apiVersion: v1
                      kind: Namespace
                      metadata:
                        name: $(namespace)
                        labels:
                          app: aks-store-demo
                          managed-by: azure-devops

                # Deploy the application manifests
                - task: Kubernetes@1
                  displayName: 'Deploy Application'
                  inputs:
                    connectionType: 'Kubernetes Service Connection'
                    kubernetesServiceEndpoint: $(kubernetesServiceConnection)
                    namespace: $(namespace)
                    command: 'apply'
                    useConfigurationFile: true
                    configuration: $(manifestFile)

                # Wait for deployments to be ready
                - task: Kubernetes@1
                  displayName: 'Wait for Deployments'
                  inputs:
                    connectionType: 'Kubernetes Service Connection'
                    kubernetesServiceEndpoint: $(kubernetesServiceConnection)
                    namespace: $(namespace)
                    command: 'rollout'
                    arguments: 'status deployment/store-front --timeout=120s'
                  continueOnError: true

                # Verify pods are running
                - task: Kubernetes@1
                  displayName: 'Verify Pods Running'
                  inputs:
                    connectionType: 'Kubernetes Service Connection'
                    kubernetesServiceEndpoint: $(kubernetesServiceConnection)
                    namespace: $(namespace)
                    command: 'get'
                    arguments: 'pods -o wide'

                # Get the LoadBalancer IP
                - task: Kubernetes@1
                  displayName: 'Get Store Front URL'
                  inputs:
                    connectionType: 'Kubernetes Service Connection'
                    kubernetesServiceEndpoint: $(kubernetesServiceConnection)
                    namespace: $(namespace)
                    command: 'get'
                    arguments: 'svc store-front -o wide'
